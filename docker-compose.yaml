version: '3.7'

services:
  # ----------------------------------------------------------------------
  # 0. PostgreSQL Database (Airflow Metadata and ETL Target)
  # ----------------------------------------------------------------------
  postgres:
    image: postgres:13
    container_name: postgres_db
    environment:
      # Airflow requires its own user and database to manage metadata
      - POSTGRES_USER=airflow
      - POSTGRES_PASSWORD=airflow
      - POSTGRES_DB=airflow
      # ETL target database
      - POSTGRES_MULTIPLE_DATABASES=movie_etl_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------------
  # 1. ETL Worker Service (Builds the image used by DockerOperator)
  # ----------------------------------------------------------------------
  etl_worker:
    # Build using the corrected Dockerfile.worker
    build: 
      context: . 
      dockerfile: Dockerfile.worker
    image: movie-etl-worker:latest
    container_name: movie_etl_worker
    env_file:
      - ./.env 
    environment:
      # CRITICAL: Connect the ETL worker to the postgres service
      - DB_HOST=postgres 
    depends_on:
      - postgres

  # ----------------------------------------------------------------------
  # 2. Airflow Webserver (UI)
  # ----------------------------------------------------------------------
  airflow_webserver:
    image: apache/airflow:2.8.1-python3.8
    container_name: airflow_webserver
    restart: always
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      # CRITICAL: Connect to the Airflow metadata database in the 'postgres' service
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
      - AIRFLOW__WEBSERVER__SECRET_KEY=super-secret-key 
    volumes:
      - ./airflow_dags:/opt/airflow/dags
      - ./requirements_airflow.txt:/requirements_airflow.txt # For installing providers
      - airflow_data:/opt/airflow
      - /var/run/docker.sock:/var/run/docker.sock # Docker socket for DockerOperator
    depends_on:
      postgres:
        condition: service_healthy
    command: webserver # Use default command

  # ----------------------------------------------------------------------
  # 3. Airflow Scheduler
  # ----------------------------------------------------------------------
  airflow_scheduler:
    image: apache/airflow:2.8.1-python3.8
    container_name: airflow_scheduler
    restart: always
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
    volumes:
      - ./airflow_dags:/opt/airflow/dags
      - ./requirements_airflow.txt:/requirements_airflow.txt
      - airflow_data:/opt/airflow
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      airflow_webserver:
        condition: service_started
    command: scheduler # Use default command

volumes:
  airflow_data: